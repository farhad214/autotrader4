code_names = {
    'ALBON': 'Albion',
    'ALCOA': 'Alcoa',
    'AMPLL': 'Ampthill',
    'ARNTT': 'Arnett',
    'BARLL': 'Barton Hill',
    'BENET': 'Benfleet',
    'BISAM': 'Bispham',
    'CAEON': 'Caernarfon',
    'CHAEY': 'Chatterley',
    'DOWII': 'Dowlais II',
    'DOWRM': 'Down Barn',
    'FENON': 'Fenton',
    'FLINT': 'Flint',
    'GOONE': 'Goose House',
    'HAWEN': 'Hawarden',
    'HEYGE': 'Heybridge',
    'HUTTE': 'Huthwaite',
    'LANGE': 'Langage',
    'LESAY': 'Lester Way',
    'LETTH': 'Letchworth',
    'LOWON': 'Lower Dunton',
    'MATNG': 'Matching',
    'MELAM': 'Melksham',
    'MIDCH': 'Middlewich',
    'MOOVE': 'Moorfield',
    'PLYAM': 'Plymouth Culham',
    'PLYCK': 'Plymouth Rock',
    'PLYTH': 'Plymouth',
    'PURET': 'XXX',
    'RAKNE': 'Rake Lane',
    'REDDA': 'Redfield Road A',
    'REDDB': 'Redfield Road B',
    'REDAR': 'Redscar',
    'SANFT': 'Sandycroft',
    'SITNE': 'XXX',
    'SUDOW': 'Sudmeadow',
    'THEVE': 'The Drove',
    'TRARK': 'Trafalgar Park',
    'TWIKS': 'XXX',
    'WATNE': 'Water Lane',
    'WREAM': 'XXXX'
}
webkey = {

    'ALCOA': 'F1AbEb2yNUX12_025IU-eK9XPZgLtpDTJ4_6xGK8wANOobU7wwcVzKGYAb1EOmgtAc8_SSAUEktQUZcSU9OXENPTlJBRFxBTENPQXxBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'BARLL': 'F1AbEb2yNUX12_025IU-eK9XPZgroIRLldX6xGK9QAiSABlwAQZ0hSq9ob1EOnAtvAUljZwUEktQUZcSU9OXENPTlJBRFxCQVJUT04gSElMTHxBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'DOWRM': 'F1AbEb2yNUX12_025IU-eK9XPZgqGxfz1RX6xGK9QAiSABlwAqEDaaHRb1VouQyVEZeHE_gUEktQUZcSU9OXENPTlJBRFxET1dOIEJBUk58QUNUSVZFIFBPV0VSIEVYUE9SVA',
    'DOWII': 'F1AbEb2yNUX12_025IU-eK9XPZgiMitdG9E6xGK8wANOobU7wZ9edEJd7b1EOmgtAc8_SSAUEktQUZcSU9OXENPTlJBRFxET1dMQUlTfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'GOONE': 'F1AbEb2yNUX12_025IU-eK9XPZgG50mk5xk6xGK9QANOobU7wG7GjNLxo1VouQyVrF2d10QUEktQUZcSU9OXENPTlJBRFxHT09TRSBIT1VTRXxBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'LESAY': 'F1AbEb2yNUX12_025IU-eK9XPZgs-7c4VJX6xGK9QAiSABlwAXPHshapob1EOnAtvAUljZwUEktQUZcSU9OXENPTlJBRFxMRVNURVIgV0FZfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'LETTH': 'F1AbEb2yNUX12_025IU-eK9XPZgPJguMDpX6xGK8wANOobU7wPLSrlxpb1VouRSVrF2d10QUEktQUZcSU9OXENPTlJBRFxMRVRDSFdPUlRIfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'MOOVE': 'F1AbEb2yNUX12_025IU-eK9XPZgZo8K7-hU6xGK9QAiSABlwAiZA6ixBrb1EOnAtvAUljZwUEktQUZcSU9OXENPTlJBRFxNT09SRklFTER8QUNUSVZFIFBPV0VSIEVYUE9SVA',
    'PLYCK': 'F1AbEb2yNUX12_025IU-eK9XPZgzLOoo1dX6xGK9QAiSABlwAzJ8tBHdb1VouQyVEZeHE_gUEktQUZcSU9OXENPTlJBRFxQTFlNT1VUSCBST0NLfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'RAKNE': 'F1AbEb2yNUX12_025IU-eK9XPZgRu2y9po_6xGK8wANOobU7wqfKCkmIAb1EOmgtAc8_SSAUEktQUZcSU9OXENPTlJBRFxSQUtFIExBTkV8QUNUSVZFIFBPV0VSIEVYUE9SVA',
    'REDDA': 'F1AbEb2yNUX12_025IU-eK9XPZgdJHeOXFE6xGK8wANOobU7wdL1bnlFI1VouRSVrF2d10QUEktQUZcSU9OXENPTlJBRFxSRURGSUVMRCBSRCBBfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'REDDB': 'F1AbEb2yNUX12_025IU-eK9XPZgS1eDm5dk6xGK9QANOobU7wS3sGPLdo1VouQyVrF2d10QUEktQUZcSU9OXENPTlJBRFxSRURGSUVMRCBSRCBCfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'SUDOW': 'F1AbEb2yNUX12_025IU-eK9XPZgu4K6VNsz6xGK8wAiSABlwAWPUXftAYf1Uzcg583iS8mAUEktQUZcSU9OXENPTlJBRFxTVURNRUFET1d8QUNUSVZFIFBPV0VSIEVYUE9SVCBMTEY',
    'THEVE': 'F1AbEb2yNUX12_025IU-eK9XPZgcVlTdFNX6xGK9QAiSABlwAnkZjEKtob1EOnAtvAUljZwUEktQUZcSU9OXENPTlJBRFxUSEUgRFJPVkV8QUNUSVZFIFBPV0VSIEVYUE9SVA',
    'TRARK': 'F1AbEb2yNUX12_025IU-eK9XPZgLf8nwFNX6xGK9QAiSABlwAwuAXpKtob1EOnAtvAUljZwUEktQUZcSU9OXENPTlJBRFxUUkFGQUxHQVIgUEFSS3xBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'PLYAM': 'F1AbEb2yNUX12_025IU-eK9XPZg-dpUyp9k6xGK9QANOobU7w-fbRbb9o1VouQyVrF2d10QUEktQUZcSU9OXENPTlJBRFxQTFlNIENVTEhBTXxBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'WATNE': 'F1AbEb2yNUX12_025IU-eK9XPZgUKKYPVRX6xGK9QAiSABlwAv72oWaxob1EOnAtvAUljZwUEktQUZcSU9OXENPTlJBRFxXQVRFUiBMQU5FfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'AMPLL': 'F1AbEb2yNUX12_025IU-eK9XPZg618zVblM6hGK3AAiSAB58gObyjb1DsmlwccgAny1LZoAUEktQUZcSU9OXENPTlJBRFxBTVBUSElMTHxBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'BENET': 'F1AbEb2yNUX12_025IU-eK9XPZgNavGaU9w6xGK9gANOobU7w50hWU6bQm1wcWAAIudR0vQUEktQUZcSU9OXENPTlJBRFxCRU5GTEVFVHxBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'BISAM': 'F1AbEb2yNUX12_025IU-eK9XPZgwKgQ10Sf6hGK5QANOobU7wEkuA7a0_mlwcSwAIudR0vQUEktQUZcSU9OXENPTlJBRFxCSVNQSEFNfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'CALNE': 'F1AbEb2yNUX12_025IU-eK9XPZgspeR9s096hGK3wANOobU7wYHQBzCSdmlwccQAIudR0vQUEktQUZcSU9OXENPTlJBRFxDQUxORXxBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'CHAEY': 'F1AbEb2yNUX12_025IU-eK9XPZgEX6Gr7426hGK3gANOobU7ww50WlVeWmlwccAAIudR0vQUEktQUZcSU9OXENPTlJBRFxDSEFUVEVSTEVZfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'FENON': 'F1AbEb2yNUX12_025IU-eK9XPZgVw7NtRvx6hGK7AANOobU7wsW4rokgR9V4O7RBtGSnfqwUEktQUZcSU9OXENPTlJBRFxGRU5UT058QUNUSVZFIFBPV0VSIEVYUE9SVA',
    'FLINT': 'F1AbEb2yNUX12_025IU-eK9XPZgHfJuwWY_6hGK3wANOobU7wzxH--4-fmlwccQAIudR0vQUEktQUZcSU9OXENPTlJBRFxGTElOVHxBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'HAWEN': 'F1AbEb2yNUX12_025IU-eK9XPZgon9CDyAH6xGK7gANOobU7wcJzSNcmnm1wcQAAIudR0vQUEktQUZcSU9OXENPTlJBRFxIQVdBUkRFTnxBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'HUTTE': 'F1AbEb2yNUX12_025IU-eK9XPZgJYcrIBzx6hGK7AANOobU7ww-fNN08R9V4O7RBtGSnfqwUEktQUZcSU9OXENPTlJBRFxIVVRIV0FJVEV8QUNUSVZFIFBPV0VSIEVYUE9SVA',
    'LANGE': 'F1AbEb2yNUX12_025IU-eK9XPZgdhW8vd8k6xGK8AANOobU7wpPYshzaEm1wcXgAIudR0vQUEktQUZcSU9OXENPTlJBRFxMQU5HQUdFfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'LOWON': 'F1AbEb2yNUX12_025IU-eK9XPZgziUnUV2j6xGK-gANOobU7wHMa3a7QDm1wcVAAIudR0vQUEktQUZcSU9OXENPTlJBRFxMT1dFUiBEVU5UT058QUNUSVZFIFBPV0VSIEVYUE9SVA',
    'MATNG': 'F1AbEb2yNUX12_025IU-eK9XPZgLHC0hLlM6hGK3AAiSAB58g_pMkvlDsmlwccgAny1LZoAUEktQUZcSU9OXENPTlJBRFxNQVRDSElOR3xBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'MELAM': 'F1AbEb2yNUX12_025IU-eK9XPZg_IZ5Xr7Q6hGK6gANOobU7wLmXpZFdwmlwcRAAIudR0vQUEktQUZcSU9OXENPTlJBRFxNRUxLU0hBTXxBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'MIDCH': 'F1AbEb2yNUX12_025IU-eK9XPZgFHInrmg_6hGK3wANOobU7wxpG3lIGfmlwccQAIudR0vQUEktQUZcSU9OXENPTlJBRFxNSURETEVXSUNIfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'PLYTH': 'F1AbEb2yNUX12_025IU-eK9XPZgMFZ1oz_36hGK7QANOobU7w4rXlmdZXmlwcQwAIudR0vQUEktQUZcSU9OXENPTlJBRFxQTFlNT1VUSHxBQ1RJVkUgUE9XRVIgRVhQT1JU',
    'REDAR': 'F1AbEb2yNUX12_025IU-eK9XPZgAeDD649u6hGK4QANOobU7w0wNT0WbOmlwcTwAIudR0vQUEktQUZcSU9OXENPTlJBRFxSRURTQ0FSfEFDVElWRSBQT1dFUiBFWFBPUlQ',
    'SANFT': 'F1AbEb2yNUX12_025IU-eK9XPZgUrmdwoJC6hGK3wANOobU7wgFoN-GvimlwccQAIudR0vQUEktQUZcSU9OXENPTlJBRFxTQU5EWUNST0ZUfEFDVElWRSBQT1dFUiBFWFBPUlQ',

}
effs = {
    'ALBON': 1,
    'ALCOA': 0.35,
    'AMPLL': 0.35,
    'ARNTT': 0.35,
    'BARLL': 0.34,
    'BENET': 0.35,
    'BISAM': 0.35,
    'CAEON': 0.35,
    'CALNE': 0.35,
    'CHAEY': 0.35,
    'DOWII': 0.35,
    'DOWRM': 0.35,
    'FENON': 0.325,
    'FLINT': 0.35,
    'GOONE': 0.32,
    'HAWEN': 0.35,
    'HEYGE': 0.35,
    'HUTTE': 0.31,
    'LANGE': 0.35,
    'LESAY': 0.31,
    'LETTH': 0.34,
    'LOWON': 0.35,
    'MATNG': 0.35,
    'MELAM': 0.35,
    'MIDCH': 0.35,
    'MOOVE': 0.32,
    'PLYAM': 0.35,
    'PLYCK': 0.34,
    'PLYTH': 0.35,
    'PURET': 0.35,
    'RAKNE': 0.35,
    'REDDA': 0.35,
    'REDDB': 0.35,
    'REDAR': 0.35,
    'SANFT': 0.31,
    'SITNE': 0.35,
    'SUDOW': 0.35,
    'THEVE': 0.32,
    'TRARK': 0.33,
    'TWIKS': 1,
    'WATNE': 0.31,
    'WREAM': 0.35
}

import pandas as pd
import json
import requests
from datetime import datetime, timedelta
import sqlalchemy as sql
import psycopg2
import pyodbc
import time
import numpy as np
from requests.auth import HTTPBasicAuth
from datetime import timezone
import __main__ as main
import sys
import inspect
import log1 as log1

# Boolean for Logging content
blc = True

ion_prefix= 'https://pi-application.conradcloud.net/ion/api/SiteProfileSubmissions/FutureSubmissions?'
headers = {'accept': 'application/json'}
c_mwh_to_th = 34.121
def get_todays_vols():

    today = datetime.today().replace(hour=0, minute=0, second=0, microsecond=0)
    start = today.strftime('%Y-%m-%dT%H:%M:%SZ')
    end = (today + timedelta(days=1)).strftime('%Y-%m-%dT%H:%M:%SZ')

    url = ion_prefix + f'startDateTime={start}&endDateTime={end}'
    json_op = json.loads(requests.get(url, headers=headers).text)

    df = pd.DataFrame()

    for i in json_op:

        # Create a column from half-hourly MWs
        df_site = pd.DataFrame(i['halfHourAverages'])

        # Create the asset name column
        df_site['asset'] = i['siteID']

        # Append content to main dataframe
        df = df.append(df_site)

    df['time'] = df['time'].apply(lambda x: pd.to_datetime(x).tz_convert(None))
    df.columns = ['uk_datetime', 'mwh_e', 'asset']
    df = df.astype(
        {
            'uk_datetime': 'datetime64[ns]',
            'mwh_e':float,
            'asset':str
        }
    )

    # convert mw to mwh
    df["mwh_e"] = df["mwh_e"] / 2

    # Pivot to daily sums
    df = pd.pivot_table(data=df,values="mwh_e",index="asset",aggfunc=np.sum).reset_index()

    # Put efficiecy values into a dataframe format
    df_eff = pd.DataFrame(list(effs.items()),columns = ['asset','eff'])

    # Merge efficiecy values with df
    df = pd.merge(df, df_eff, on="asset", how="left")

    # Calculate consumed gas
    df["mwh_g_req_to_gen"] = df["mwh_e"]/df["eff"]

    # Therms required to generate
    df["th_g_req_gen"] = (c_mwh_to_th*df["mwh_g_req_to_gen"]).round()

    # return result
    return df

def mf_ion():
    df_vols = get_todays_vols()

# if __name__ == "__main__":
#     mf_ion()